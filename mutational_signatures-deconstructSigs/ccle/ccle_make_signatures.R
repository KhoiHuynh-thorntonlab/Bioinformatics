#!/usr/bin/env Rscript
# using R 3.2.3

# Script to create genomic profiles & comparisons as requested by R.P. lab
# 'how strong each mutational process is between samples'
# method for doing this is described here (https://www.nature.com/articles/ncomms9683), and in the methods section entitled “Estimating the contributions of mutational signatures in each sample”. An example of the output generated is provided in Supplementary Table 2.
# how each signature is being interpreted description here: http://cancer.sanger.ac.uk/cosmic/signatures
# 
# using broad public RNASeq tumor dataset from here https://portals.broadinstitute.org/ccle/data ; file 'ccle2maf_081117.txt'

# USAGE: $ Rscript ccle_make_signatures.R "SampleID"
# This script operates on a single sample at a time; submit for all samples in parrallel on the HPC



# ~~~~~ SCRIPT ARGS ~~~~~ #
args <- commandArgs(T)
sampleID <- args[1]
message(sprintf("sample ID: %s\n\n", sampleID))

# output file location
signatures_dir <- "signatures"



# ~~~~~ LOAD DATA ~~~~~ # 
# load the data generated by `clean.R`
load(file = "ccle_sigs.input.Rdata") # sigs.input

# make sure a valid sample ID was passed
if(! sampleID %in% rownames(sigs.input)){
    message(sprintf("ERROR: sample ID not found in dataset: %s\n\n", sampleID))
    quit()
}


# ~~~~~ FIND SIGNATURES ~~~~~ # 
message("\nLoading Packages...\n\n")
library("BSgenome.Hsapiens.UCSC.hg19")
library("deconstructSigs")
message("\n\nMaking signatures...\n\n")
signatures <- whichSignatures(tumor.ref = sigs.input,
                              signatures.ref = signatures.cosmic,
                              sample.id = sampleID,
                              contexts.needed = TRUE,
                              tri.counts.method = 'default')


# ~~~~~ SAVE SIGNATURES ~~~~~ # 
signatures_output_file <- file.path(signatures_dir, sprintf('%s.Rds', sampleID))
message(sprintf("\n\nSaving signatures to file: %s\n\n", signatures_output_file))
saveRDS(object = signatures, file = signatures_output_file, compress = TRUE)



# ~~~~~ SAVE PLOTS ~~~~~ # 
signatures_plot_file <- file.path(signatures_dir, sprintf('%s.pdf', sampleID))
message(sprintf("\n\nSaving signatures plots to file: %s\n\n", signatures_plot_file))
pdf(file = signatures_plot_file)
print(plotSignatures(signatures, sub = 'signatures.cosmic'))
print(makePie(signatures, sub = 'signatures.cosmic'))
dev.off()
